generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model RiceMill {
  id              String          @id @default(cuid())
  name            String
  email           String          @unique
  phone           String?
  address         String?
  licenseNo       String?         @unique
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  districts       District[]
  gatePassEntries GatePassEntry[]
  seasons         Season[]
  societies       Society[]
  users           User[]

  @@map("rice_mills")
}

model User {
  id         String    @id @default(cuid())
  email      String    @unique
  password   String
  name       String
  role       UserRole  @default(OPERATOR)
  riceMillId String?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  riceMill   RiceMill? @relation(fields: [riceMillId], references: [id], onDelete: Cascade)

  @@index([riceMillId])
  @@map("users")
}

model District {
  id              String          @id @default(cuid())
  name            String
  code            String?
  state           String?
  riceMillId      String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  riceMill        RiceMill        @relation(fields: [riceMillId], references: [id], onDelete: Cascade)
  gatePassEntries GatePassEntry[]
  societies       Society[]

  @@unique([name, riceMillId])
  @@unique([code, riceMillId])
  @@index([riceMillId])
  @@index([name])
  @@index([state])
  @@map("districts")
}

model Society {
  id              String          @id @default(cuid())
  name            String
  code            String
  districtId      String
  riceMillId      String
  address         String?
  contactNo       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  gatePassEntries GatePassEntry[]
  parties         Party[]
  district        District        @relation(fields: [districtId], references: [id], onDelete: Cascade)
  riceMill        RiceMill        @relation(fields: [riceMillId], references: [id], onDelete: Cascade)
  targets         SocietyTarget[]

  @@unique([code, riceMillId])
  @@index([riceMillId])
  @@index([districtId])
  @@index([name])
  @@index([riceMillId, districtId])
  @@map("societies")
}

model Party {
  id              String          @id @default(cuid())
  name            String
  fatherName      String?
  phone           String?
  address         String?
  societyId       String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  gatePassEntries GatePassEntry[]
  society         Society         @relation(fields: [societyId], references: [id], onDelete: Cascade)

  @@index([societyId])
  @@index([name])
  @@index([phone])
  @@index([societyId, name])
  @@map("parties")
}

model GatePassEntry {
  id           String      @id @default(cuid())
  serialNumber Int         @default(autoincrement())
  tokenNo      String
  date         DateTime    @default(now())
  partyName    String
  pacsName     String
  vehicleType  VehicleType @default(TRUCK)
  vehicleNo    String?
  bags         Int
  quantity     Float
  remarks      String?
  challanNo    String?
  riceMillId   String
  societyId    String
  districtId   String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  partyId      String
  seasonId     String
  district     District    @relation(fields: [districtId], references: [id], onDelete: Cascade)
  party        Party       @relation(fields: [partyId], references: [id], onDelete: Cascade)
  riceMill     RiceMill    @relation(fields: [riceMillId], references: [id], onDelete: Cascade)
  season       Season      @relation(fields: [seasonId], references: [id])
  society      Society     @relation(fields: [societyId], references: [id], onDelete: Cascade)

  @@unique([tokenNo, riceMillId])
  @@unique([serialNumber, riceMillId])
  @@index([tokenNo])
  @@index([date])
  @@index([serialNumber])
  @@index([partyName])
  @@index([vehicleNo])
  @@index([riceMillId])
  @@index([societyId])
  @@index([partyId])
  @@index([seasonId])
  @@index([districtId])
  @@index([pacsName])
  @@index([challanNo])
  @@index([riceMillId, seasonId])
  @@index([riceMillId, date])
  @@index([riceMillId, societyId])
  @@index([riceMillId, districtId])
  @@index([seasonId, societyId])
  @@index([seasonId, date])
  @@index([date, riceMillId, seasonId])
  @@map("gate_pass_entries")
}

model Season {
  id              String          @id @default(cuid())
  name            String
  type            SeasonType
  isActive        Boolean         @default(false)
  riceMillId      String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  gatePassEntries GatePassEntry[]
  riceMill        RiceMill        @relation(fields: [riceMillId], references: [id], onDelete: Cascade)
  targets         SocietyTarget[]

  @@unique([name, type, riceMillId])
  @@index([riceMillId])
  @@index([isActive])
  @@index([riceMillId, isActive])
  @@index([type])
  @@map("seasons")
}

model SocietyTarget {
  id             String   @id @default(cuid())
  seasonId       String
  societyId      String
  targetQuantity Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  season         Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  society        Society  @relation(fields: [societyId], references: [id], onDelete: Cascade)

  @@unique([seasonId, societyId])
  @@index([seasonId])
  @@index([societyId])
  @@map("society_targets")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  OPERATOR
}

enum SeasonType {
  KHARIF
  RABI
}

enum VehicleType {
  TRACTOR
  TRUCK
  TATA_ACE
}
